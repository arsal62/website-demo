<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Upload Functionality</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Upload Test</h2>
        
        <!-- Test Login -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Step 1: Login Test</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" class="form-control mb-2" id="testUsername" placeholder="Username" value="admin">
                        <input type="password" class="form-control mb-2" id="testPassword" placeholder="Password" value="admin123">
                        <button class="btn btn-primary" onclick="testLogin()">Test Login</button>
                    </div>
                    <div class="col-md-6">
                        <div id="loginResult" class="alert" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Health Check -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Step 2: Server Health Test</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-info" onclick="testHealth()">Test Server Health</button>
                <div id="healthResult" class="mt-2"></div>
            </div>
        </div>

        <!-- Test Upload -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Step 3: Upload Test</h5>
            </div>
            <div class="card-body">
                <form id="testUploadForm">
                    <div class="row">
                        <div class="col-md-4">
                            <input type="text" class="form-control mb-2" placeholder="Title" value="Test Resource" required>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select mb-2" required>
                                <option value="O Level">O Level</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select mb-2" required>
                                <option value="English">English</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <select class="form-select mb-2" required>
                                <option value="Paper 1">Paper 1</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select mb-2" required>
                                <option value="Reading">Reading</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="file" class="form-control mb-2" accept=".pdf,.doc,.docx,.txt" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">Test Upload</button>
                </form>
                <div id="uploadResult" class="mt-2"></div>
            </div>
        </div>

        <!-- Test Resources Display -->
        <div class="card">
            <div class="card-header">
                <h5>Step 4: Resources Display Test</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-secondary" onclick="testResourcesDisplay()">Test Resources Display</button>
                <div id="resourcesResult" class="mt-2"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = 'http://localhost:3000';
        let authToken = null;

        async function testHealth() {
            const result = document.getElementById('healthResult');
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`);
                const data = await response.json();
                
                if (response.ok) {
                    result.innerHTML = '<div class="alert alert-success">✓ Server is healthy: ' + data.message + '</div>';
                } else {
                    result.innerHTML = '<div class="alert alert-danger">✗ Server health check failed</div>';
                }
            } catch (error) {
                result.innerHTML = '<div class="alert alert-danger">✗ Cannot connect to server: ' + error.message + '</div>';
            }
        }

        async function testLogin() {
            const username = document.getElementById('testUsername').value;
            const password = document.getElementById('testPassword').value;
            const result = document.getElementById('loginResult');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    result.className = 'alert alert-success';
                    result.textContent = '✓ Login successful! Token received.';
                    result.style.display = 'block';
                } else {
                    result.className = 'alert alert-danger';
                    result.textContent = '✗ Login failed: ' + data.error;
                    result.style.display = 'block';
                }
            } catch (error) {
                result.className = 'alert alert-danger';
                result.textContent = '✗ Login error: ' + error.message;
                result.style.display = 'block';
            }
        }

        document.getElementById('testUploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!authToken) {
                alert('Please login first!');
                return;
            }

            const result = document.getElementById('uploadResult');
            const formData = new FormData();
            
            const inputs = this.querySelectorAll('input, select');
            formData.append('title', inputs[0].value);
            formData.append('level', inputs[1].value);
            formData.append('subject', inputs[2].value);
            formData.append('paper', inputs[3].value);
            formData.append('category', inputs[4].value);
            formData.append('file', inputs[5].files[0]);
            formData.append('description', 'Test upload description');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/upload-resource`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    result.innerHTML = '<div class="alert alert-success">✓ Upload successful! Resource ID: ' + data.id + '</div>';
                } else {
                    result.innerHTML = '<div class="alert alert-danger">✗ Upload failed: ' + data.error + '</div>';
                }
            } catch (error) {
                result.innerHTML = '<div class="alert alert-danger">✗ Upload error: ' + error.message + '</div>';
            }
        });

        async function testResourcesDisplay() {
            const result = document.getElementById('resourcesResult');
            try {
                const response = await fetch(`${API_BASE_URL}/api/resources?level=O Level&subject=English&paper=Paper 1&category=Reading`);
                const data = await response.json();
                
                if (response.ok) {
                    result.innerHTML = `<div class="alert alert-success">✓ Found ${data.resources.length} resources</div>
                        <div class="mt-2">
                            ${data.resources.map(r => `
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <h6>${r.title}</h6>
                                        <small>Uploaded: ${new Date(r.upload_date).toLocaleDateString()}</small>
                                        <br>
                                        <a href="${API_BASE_URL}/api/download/${r.id}" class="btn btn-sm btn-primary mt-1">Download</a>
                                    </div>
                                </div>
                            `).join('')}
                        </div>`;
                } else {
                    result.innerHTML = '<div class="alert alert-danger">✗ Failed to load resources</div>';
                }
            } catch (error) {
                result.innerHTML = '<div class="alert alert-danger">✗ Resources display error: ' + error.message + '</div>';
            }
        }

        // Auto-test health on page load
        window.addEventListener('load', () => {
            testHealth();
        });
    </script>
</body>
</html>